<html>
<head>
  <title>PHP-OOP6-day23(PDO,增改删查，预处理，事务处理，异常)</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/303788 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1801"/>
<h1>PHP-OOP6-day23(PDO,增改删查，预处理，事务处理，异常)</h1>

<div>
<span><div><b><span style="font-size: 21px;">PHP-OOP6-day23(PDO,增改删查，预处理，事务处理，异常)</span></b></div><div align="left" style="min-height: 10pt;"><div><span style="font-size: 19px;"><b><font color="#010101">一、php data object （php数据对象）//本节内容主要看代码</font></b></span></div><div align="left" style="min-height: 10pt;"><div style="margin-left:40px;"><b><font color="#010101" size="1"><span style="font-size:9pt">1、pdo为php提供了访问数据库的一个轻量级的一致<span style="color: rgb(255, 0, 0);">接口</span></span></font></b></div></div><div align="left" style="min-height: 10pt;"><div style="margin-left:40px;"><b><font color="#010101" size="1"><span style="font-size:9pt">因此pdo是php访问数据库的一个抽象层，不管使用哪种数据库，都可以用相同的方法来查询和获取数据。</span></font></b></div><div style="margin-left:40px;"><b><span style="font-size: 9pt;"><span style="color: rgb(1, 1, 1);">优点：</span></span><font color="#010101" size="1"><span style="font-size:9pt">pdo可以防止sql注入，安全性更好</span></font></b></div><div align="left" style="min-height: 10pt;"><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="margin-left:40px;"><b>sql注入的案例：  万能账号：' or 1 = 1#</b></div><div style="margin-left:40px;"><b>                         万能密码：'or 1='1</b></div></div><div style="margin-left:40px;">2、PDO功能开启：<font color="#010101" size="1"><span style="font-size:9pt">去掉php.ini中 extension=php_pdo_mysql.dll 前的 ‘；’。</span></font></div><div align="left" style="min-height: 10pt;"><div style="margin-left:40px;"><font color="#010101" size="1"><span style="font-size:9pt">3、PDO三个类：</span></font></div><div align="justify" style="min-height: 14pt;"><div style="margin-left:40px;"><font color="#010101" size="2"><span style="font-size:10pt">PDO</span></font><font color="#010101" size="2"><span style="font-size:10pt">类：</span></font><font color="#010101" size="2"><span style="font-size:10pt">PDO</span></font><font color="#010101" size="2"><span style="font-size:10pt">的核心，主要用于数据的连接、发送</span></font><font color="#010101" size="2"><span style="font-size:10pt">SQL</span></font><font color="#010101" size="2"><span style="font-size:10pt">语句等</span></font><font color="#010101" size="2"><span style="font-size:10pt">…</span></font></div></div><div align="justify" style="min-height: 14pt;margin-left:40px;"><div><font color="#010101" size="2"><span style="font-size:10pt">PDOStatement</span></font><font color="#010101" size="2"><span style="font-size:10pt">类：主要用于解析结果集，实现预处理、事务处理等特殊功能</span></font><font color="#010101" size="2"><span style="font-size:10pt">……</span></font></div></div><div align="justify" style="min-height: 14pt;"><div style="margin-left:40px;"><font color="#010101" size="2"><span style="font-size:10pt">PDOException</span></font><font color="#010101" size="2"><span style="font-size:10pt">类：主要用于捕获</span></font><font color="#010101" size="2"><span style="font-size:10pt">PDO</span></font><font color="#010101" size="2"><span style="font-size:10pt">异常</span></font></div><div><b><span style="font-size: 19px;"><span style="color: rgb(1, 1, 1);">二、PDO类</span></span></b></div><div><span style="color: rgb(255, 0, 0);"><b>    //注意：如果使用了命名空间，则要引入PDO类</b></span></div><div><span style="color: rgb(255, 0, 0);"><b>    use PDO;</b></span></div><div><span style="color: rgb(255, 0, 0);"><b>    use PDOException;</b></span></div><div align="justify" style="min-height: 14pt;"><div style="margin-left:40px;"><font color="#010101" size="2"><span style="font-size:10pt">①构造函数</span></font><font color="#010101" size="2"><span style="font-size:10pt">:PDO</span></font><font color="#010101" size="2"><span style="font-size:10pt">类中使用了构造方法（面向对象中我们学习过了实例化类的时候可以给类中的构造方法传值）</span></font></div></div><div align="justify" style="min-height: 12pt;margin-left:40px;"><div><font color="#010101" size="2"><span style="font-size:10pt">PDO::__construct() ( string $dsn[, string $username [, string $password ]] )</span></font></div></div><div align="justify" style="min-height: 14pt;"><div style="margin-left:40px;"><font color="#010101" size="2"><span style="font-size:10pt">$dsn</span></font> <font color="#010101" size="2"><span style="font-size:10pt">：数据源，字符串类型，格式：</span></font><font color="#010101" size="2"><span style="font-size:10pt">mysql:host=localhost;dbname=project</span></font></div><div align="left" style="min-height: 10pt;"><div style="margin-left:40px;"><font color="#010101" size="1"><span style="font-size:9pt">返回：pdo对象$pdo</span></font></div><div align="left" style="min-height: 10pt;"><div align="justify" style="min-height: 13pt;"><div style="margin-left:40px;"><font color="#010101" size="2"><span style="font-size:10pt">②</span></font><font color="#010101" size="1"><span style="font-size:9pt">PDO销毁:PDO类没有提供自动销毁的方法，为了节省内存，我们一般会手动销毁PDO对象。</span></font></div><div align="left" style="min-height: 10pt;"><div style="margin-left:40px;"><font color="#010101" size="1"><span style="font-size:9pt">将pdo对象赋值为null,</span></font><font color="#010101" size="1"><span style="font-size:9pt">使用<b>unset()</b>函数进行销毁</span></font></div><div><span style="font-size: 19px;"><b>三、增改删查</b></span></div><div style="margin-left:40px;">（1）增改删int PDO::<b>exec</b> ( string $statement )</div><div align="justify" style="min-height: 14pt;margin-left:40px;"><div style="margin-left:40px;"><font color="#010101" size="2"><span style="font-size:10pt">主要功能：实现对</span></font><font color="#010101" size="2"><span style="font-size:10pt">SQL</span></font><font color="#010101" size="2"><span style="font-size:10pt">语句的执行操作，<b>返回的是受影响的行总数</b>。</span></font></div></div><div align="justify" style="min-height: 13pt;"><div style="margin-left:80px;"><font color="#010101" size="2"><span style="font-size:10pt">参数说明：</span></font><font color="#010101" size="2"><span style="font-size:10pt">$statement</span></font> <font color="#010101" size="2"><span style="font-size:10pt">：要执行的</span></font><font color="#010101" size="2"><span style="font-size:10pt">SQL</span></font><font color="#010101" size="2"><span style="font-size:10pt">语句（要求是</span></font><font color="#010101" size="2"><span style="font-size:10pt">insert/update/delete</span></font><font color="#010101" size="2"><span style="font-size:10pt">）</span></font></div><div style="margin-left:40px;"><span style="color: rgb(1, 1, 1);">（2）</span>string PDO::<b>lastInsertId()</b><font color="#010101" size="2"><span style="font-size:10pt">主要功能：返回<b>最后</b>一条<b>插入</b>数据的</span></font><b><font color="#010101" size="2"><span style="font-size:10pt">id</span></font></b><font color="#010101" size="2"><span style="font-size:10pt">。</span></font></div><div style="margin-left:40px;">（3）查询</div><div style="margin-left:40px;">第一步：<font color="#010101" size="1"><span style="font-size:9pt">获取pdostatement对象，例:$pdo-&gt;执行后得到$stmt</span></font></div><div style="margin-left:40px;">PDOStatement PDO::<b>query</b> ( string $statement )</div><div align="justify" style="min-height: 14pt;margin-left:40px;"><div><font color="#010101" size="2"><span style="font-size:10pt">主要功能：实现对</span></font><font color="#010101" size="2"><span style="font-size:10pt">SQL</span></font><font color="#010101" size="2"><span style="font-size:10pt">语句的查询操作（针对</span></font><font color="#010101" size="2"><span style="font-size:10pt">select</span></font><font color="#010101" size="2"><span style="font-size:10pt">语句），返回</span></font><font color="#010101" size="2"><span style="font-size:10pt">PDOStatement</span></font><font color="#010101" size="2"><span style="font-size:10pt">对象</span></font></div></div><div align="justify" style="min-height: 13pt;"><div style="margin-left:40px;"><font color="#010101" size="2"><span style="font-size:10pt">参数说明：</span></font><font color="#010101" size="2"><span style="font-size:10pt">$statement</span></font> <font color="#010101" size="2"><span style="font-size:10pt">：就代表要执行的</span></font><font color="#010101" size="2"><span style="font-size:10pt">select</span></font><font color="#010101" size="2"><span style="font-size:10pt">查询语句。</span></font></div><div style="margin-left:40px;"><span style="color: rgb(1, 1, 1);">第二步：</span><font color="#010101" size="1"><span style="font-size:9pt">获取结果集相关数据</span></font></div><div style="margin-left:40px;">1、int PDOStatement::rowCount ( void )：返回数据表中的总行数</div><div style="margin-left:40px;">2、int PDOStatement::columnCount ( void ) ：返回数据表中字段的总列数</div><div style="margin-left:40px;">3、fetch<font color="#010101" size="1"><span style="font-size:9pt">说明：PDOStatement::fetch — 从结果集中获取下一行 </span></font></div><div align="left" style="min-height: 10pt;margin-left:40px;"><div><font color="#010101" size="1"><span style="font-size:9pt">语法：mixed PDOStatement::fetch ( int $fetch_style )实现对数据的遍历输出，每次只能遍历一条记录，然后指针向下移动一位！</span></font></div></div><div align="left" style="min-height: 10pt;"><div align="left" style="min-height: 10pt;margin-left:40px;"><div><font color="#010101" size="1"><span style="font-size:9pt">4、PDO::FETCH_BOUND</span></font></div></div><div align="left" style="min-height: 10pt;margin-left:40px;"><div><font color="#010101" size="1"><span style="font-size:9pt">需要结合PDO::FETCH_BOUND(bindColumn)来实现</span></font></div></div><div align="left" style="min-height: 10pt;margin-left:40px;"><div><font color="#010101" size="1"><span style="font-size:9pt">语法：bool PDOStatement::bindColumn ( mixed $column , mixed &amp;$param  )</span></font></div></div><div align="left" style="min-height: 10pt;margin-left:40px;"><div><font color="#010101" size="1"><span style="font-size:9pt">参数：</span></font><font color="#010101" size="1"><span style="font-size:9pt">$column 结果集的列号（从1开始索引），</span></font><font color="#010101" size="1"><span style="font-size:9pt">$param  要绑定到的变量名</span></font></div></div><div align="left" style="min-height: 10pt;"><div align="left" style="min-height: 10pt;"><div style="margin-left:40px;"><font color="#010101" size="1"><span style="font-size:9pt">说明：<b>PDOStatement::fetchAll</b> — 返回一个包含结果集中所有行的数组</span></font></div><div style="margin-left:40px;"><font color="#010101" size="1"><span style="font-size:9pt">5、参</span></font><font color="#010101" size="1"><span style="font-size:9pt">数：$fetch_style 控制下一行如何返回给调用者，可选的值为：</span></font></div><div align="left" style="min-height: 10pt;margin-left:40px;"><div style="margin-left:40px;"><font color="#010101" size="1"><span style="font-size:9pt">a、<b>PDO::FETCH_ASSOC</b> ：把一条记录遍历到关联数组中</span></font></div></div><div align="left" style="min-height: 10pt;margin-left:80px;"><div><font color="#010101" size="1"><span style="font-size:9pt">b、PDO::FETCH_NUM ：把一条记录遍历到索引型数组中</span></font></div></div><div align="left" style="min-height: 10pt;margin-left:80px;"><div><font color="#010101" size="1"><span style="font-size:9pt">c、PDO::FETCH_BOTH ：把一条记录遍历到混合型数组中</span></font></div></div><div align="left" style="min-height: 10pt;margin-left:80px;"><div><font color="#010101" size="1"><span style="font-size:9pt">d、PDO::FETCH_OBJ ：把一条记录遍历到对象中</span></font></div></div><div align="left" style="min-height: 10pt;"><div style="margin-left:80px;"><font color="#010101" size="1"><span style="font-size:9pt">e、PDO::FETCH_BOUND (bindColumn) ：把某个变量绑定到结果集中的某个列</span></font></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    try{</span><b>//PDO中的遍历操作</b></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        <b>$mq='mysql';</b></span></span></div><div><b><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $user='root';</span></span></b></div><div><b><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $pass=123456;</span></span></b></div><div><b><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $dbname='</span></span></b>whereit<b><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">';</span></span></b></div><div><b><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $dsn=&quot;$mq:host=127.0.0.1;dbname=$dbname&quot;;</span></span></b></div><div><b><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $pdo=new PDO($dsn,$user,$pass);</span></span></b></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        //设置PDO属性实现捕获逻辑异常</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        <b>$pdo-&gt;setAttribute(PDO::ATTR_ERRMODE,PDO::ERRMODE_EXCEPTION);</b></span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $time=time();</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        // $sql=&quot;insert into user values(null,'zhaoliu','zhaoliu@163.com',$time)&quot;;//插入</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        // $sql=&quot;update user set `int`=$time&quot;;//查询</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        // $sql=&quot;delete from user where uid=8&quot;;//删除</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $sql=&quot;select * from user&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        // $flag=$pdo-&gt;exec($sql);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        <b>$flag=$pdo-&gt;query($sql);//$flag即</b></span></span><b><font color="#010101" size="2"><span style="font-size:10pt">返回的</span></font><font color="#010101" size="2"><span style="font-size:10pt">PDOStatement</span></font><font color="#010101" size="2"><span style="font-size:10pt">对象</span></font></b></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        echo &quot;&lt;pre&gt;&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        echo $pdo-&gt;lastInsertId();</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        var_dump($flag);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        <b>$count=$flag-&gt;rowCount();//获取结果集中的总行数</b></span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        echo $count,&quot;&lt;br/&gt;&quot;,<b>$flag-&gt;columnCount()</b>,&quot;&lt;hr/&gt;&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        //一、PDO::FETCH_ASSOC遍历</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        // foreach ($flag as $key) {//遍历方法1</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        //     var_dump($key);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        //     echo &quot;&lt;br/&gt;&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        // }</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        // for ($i=0; $i &lt;$count; $i++) {//遍历方法2</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        //     $row=$flag-&gt;fetch(PDO::FETCH_ASSOC);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        //     var_dump($row);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        // }</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        // while ($row=$flag-&gt;fetch(PDO::FETCH_ASSOC)) {//遍历方法3</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        //     var_dump($row);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        // }</span></span></div><div><b><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        //二、绑定遍历</span></span></b></div><div><b><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $flag-&gt;bindColumn(2,$username);//这里的索引是id</span></span></b></div><div><b><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $flag-&gt;bindColumn(3,$email);</span></span></b></div><div><b><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $flag-&gt;bindColumn(4,$int);</span></span></b></div><div><b><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        for ($i=0; $i &lt;$count; $i++) {//遍历方法2</span></span></b></div><div><b><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">            $flag-&gt;fetch(PDO::FETCH_BOUND);</span></span></b></div><div><b><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">            echo $username,'-',$email,'-',$int;</span></span></b></div><div><b><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">            echo &quot;&lt;br/&gt;&quot;;</span></span></b></div><div><b><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        }</span></span></b></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        //三、fetchAll遍历方法2</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        // $data=$flag-&gt;fetchAll(PDO::FETCH_ASSOC);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        // for ($i=0; $i &lt;$count; $i++) {</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        //     echo $data[$i]['username'],'-',$data[$i]['email'],'-',$data[$i]['int'];</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        //     echo &quot;&lt;br/&gt;&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        // }       </span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        // if (!$flag) {//PDO中的逻辑错误（手工抛出异常）</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        //     throw new PDOException(&quot;SQL语句执行失败！&quot;, 10000);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        // }</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    }catch(PDOException $e){</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        echo &quot;错误编号&quot;.$e-&gt;getCode().&quot;&lt;hr/&gt;&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        echo &quot;错误行&quot;.$e-&gt;getLine().&quot;&lt;hr/&gt;&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        echo &quot;错误信息&quot;.$e-&gt;getMessage();</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    }</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    <b>unset($pdo);</b></span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    echo &quot;&lt;hr/&gt;&quot;;</span></span></div></div><div align="left" style="min-height: 10pt;"><div align="left" style="min-height: 10pt;"><div><span style="font-size: 19px;"><b><font color="#010101">四、PDO预处理</font></b></span></div></div><div><font color="#010101" size="1"><span style="font-size:9pt">预处理功能就是在sql语句结构与形式相同的情况下，只有参数不同所采用的一种数据处理机制，极大地减少了带宽的浪费。</span></font></div><div align="left" style="min-height: 10pt;"><div style="margin-left:40px;"><font color="#010101" size="1"><span style="font-size:9pt">第一步：组装sql语句</span></font></div></div><div align="left" style="min-height: 10pt;margin-left:40px;"><div><font color="#010101" size="1"><span style="font-size:9pt">$sql = &quot;insert into tb_admin values (null, :username,:password,:time)&quot;;</span></font></div></div><div align="left" style="min-height: 10pt;margin-left:40px;"><div><font color="#010101" size="1"><span style="font-size:9pt">或者</span></font><font color="#010101" size="1"><span style="font-size:9pt">$sql = &quot;insert into tb_admin values (null, ?, ?, ?)&quot;;</span></font></div></div><div align="left" style="min-height: 10pt;margin-left:40px;"><div><font color="#010101" size="1"><span style="font-size:9pt">做预处理时，可以使用文本标识也可以使用问号，两者的功能都是一致的，唯一的不同就是语法的不同。</span></font></div></div><div align="left" style="min-height: 10pt;margin-left:40px;"><div><font color="#010101" size="1"><span style="font-size:9pt">①如果使用文本标识，其在数据传递时，要求数组是一个关联型数组</span></font></div></div><div align="left" style="min-height: 10pt;"><div style="margin-left:40px;"><font color="#010101" size="1"><span style="font-size:9pt">②如果使用问号标识，其在数据传递时，要求数组是一个索引型数组，索引从0开始</span></font></div><div align="left" style="min-height: 10pt;margin-left:40px;"><div><font color="#010101" size="1"><span style="font-size:9pt">第二步：定义预处理语句</span></font><font color="#010101" size="1"><span style="font-size:9pt">$stmt = $pdo-&gt;prepare($sql);</span></font></div></div><div align="left" style="min-height: 10pt;"><div align="left" style="min-height: 10pt;"><div style="margin-left:40px;"><font color="#010101" size="1"><span style="font-size:9pt">第三步，绑定或设置参数并发送（分</span></font><font color="#010101" size="1"><span style="font-size:9pt">不使用bindParam，</span></font><font color="#010101" size="1"><span style="font-size:9pt">使用bindParam两种情况</span></font><font color="#010101" size="1"><span style="font-size:9pt">）</span></font></div><div align="left" style="min-height: 10pt;margin-left:40px;"><div><font color="#010101" size="1"><span style="font-size:9pt">     注意：</span></font><font color="#010101" size="1"><span style="font-size:9pt">如果使用bindParam绑定参数，bindParam( )的第二个参数不能为一个具体值，因为bindParam第二个参数为引用传值</span></font></div></div><div align="left" style="min-height: 10pt;"><div style="margin-left:40px;"><font color="#010101" size="1"><span style="font-size:9pt">如果占位符为?,索引是从1开始的</span></font></div></div></div></div></div></div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">   </span> <b>//两个方法使用预处理</b></span><font color="#010101" size="1"><span style="font-size:9pt">（</span></font><font color="#010101" size="1"><span style="font-size:9pt">不使用bindParam，</span></font><font color="#010101" size="1"><span style="font-size:9pt">使用bindParam</span></font><font color="#010101" size="1"><span style="font-size:9pt">）</span></font></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    header(&quot;Content-type:text/html;charset=utf-8&quot;);//1、设置响应头信息</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    try{</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    //2、实例化pdo类</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $mq='mysql';</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $user='root';</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $pass=123456;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $dbname='</span></span>whereit<span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">';</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $dsn=&quot;$mq:host=127.0.0.1;dbname=$dbname&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $time=time();</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $pdo=new PDO($dsn,$user,$pass);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $pdo-&gt;setAttribute(PDO::ATTR_ERRMODE,PDO::ERRMODE_EXCEPTION);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">  <b>  //3、组装SQL语句</b></span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $sql=&quot;insert into user values(null,:username,:email,:time)&quot;;<b>//一1、预处理使用文本标识</b></span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        // $sql=&quot;insert into user values(null,?,?,?)&quot;;<b>//一2、预处理使用问号标识</b></span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    <b>//4、定义预处理语句</b></span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        <b>$stmt=$pdo-&gt;prepare($sql);</b></span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    // <b>//5、使用execute传递参数 </b></span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    //     $username='sunba';</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    //     $email='sunba@sina.com';</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    //     $data=array(</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    //         ':username'=&gt;$username,    // 0=&gt;$username,</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    //         ':email'=&gt;$email,        // 1=&gt;$email,</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    //         ':time'=&gt;$time            // 2=&gt;$time</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    //         );</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    // $stmt-&gt;execute($data);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    <b>// 二、预处理使用bindParam实现参数绑定（推荐）</b></span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    // 5绑定参数</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    $stmt-&gt;bindParam(':username',$username);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    $stmt-&gt;bindParam(':email',$email);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    $stmt-&gt;bindParam(':time',$time);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    //6设置参数</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    $username='zhouwu';</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    $email='zhouwu@yahoo.com';</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    $stmt-&gt;<b>execute();</b>//7执行预处理语句     </span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    }catch(PDOException $e){</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        echo &quot;错误编号&quot;.$e-&gt;getCode().&quot;&lt;hr/&gt;&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        echo &quot;错误行&quot;.$e-&gt;getLine().&quot;&lt;hr/&gt;&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        echo &quot;错误信息&quot;.$e-&gt;getMessage();</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    }</span></span></div></div><div align="left" style="min-height: 10pt;"><div><span style="font-size: 19px;"><b>五、事务处理：<span style="font-size: 16px;">要想实现事务处理，要求：数据库必须是</span><span style="color: rgb(255, 0, 0);">innoDB引擎</span></b></span></div><div align="justify" style="min-height: 13pt;"><div style="margin-left:40px;"><font color="#010101" size="2"><span style="font-size:10pt">开启事务</span></font><font color="#010101" size="1"><span style="font-size:9pt">$pdo-&gt;beginTransaction()</span></font></div></div><div align="left" style="min-height: 10pt;margin-left:40px;"><div><font color="#010101" size="1"><span style="font-size:9pt">当提交或者回滚一个事物之后，事物结束。接下来的操作将不再事物操作范围之中。</span></font></div></div><div align="left" style="min-height: 10pt;"><div style="margin-left:40px;"><font color="#010101" size="1"><span style="font-size:9pt">var_dump($pdo-&gt;inTransaction());//判断是否在事务中bool(true)</span></font></div><div align="justify" style="min-height: 14pt;margin-left:40px;"><div><font color="#010101" size="2"><span style="font-size:10pt">提交事务：</span></font><font color="#010101" face="����" size="1"><span style="font-size:9pt">$pdo-&gt;</span></font><font color="#010101" size="2"><span style="font-size:10pt">commit;</span></font></div></div><div align="justify" style="min-height: 14pt;"><div style="margin-left:40px;"><font color="#010101" size="2"><span style="font-size:10pt">回滚事务：</span></font><font color="#010101" face="����" size="1"><span style="font-size:9pt">$pdo-&gt;</span></font><font color="#010101" size="2"><span style="font-size:10pt">rollBack;</span></font></div></div></div></div><div style="box-sizing: border-box; padding: 8px; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;"> </span> <b>  // 同时操作数据库a表和b表，其中一个操作失败则事务回滚</b></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    try{</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $mq='mysql';</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $user='root';</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $pass='123456';</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $dbname='</span></span>whereit<span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">';</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $dsn=&quot;$mq:host=127.0.0.1;dbname=$dbname&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $time=time();</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $pdo=new PDO($dsn,$user,$pass);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $pdo-&gt;setAttribute(PDO::ATTR_ERRMODE,PDO::ERRMODE_EXCEPTION);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $pdo-&gt;beginTransaction();//开启事务处理</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $sql1=&quot;update student set salary=salary-1000 where id&lt;5&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $sql2=&quot;update user set `int`=$time w格式提供here uid&lt;5&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        var_dump($pdo-&gt;inTransaction());//判断是否在事务中bool(true)</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        echo &quot;&lt;hr/&gt;&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $effect1=$pdo-&gt;exec($sql1);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        $effect2=$pdo-&gt;exec($sql2);</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        if (!($effect1&amp;&amp;$effect2)) {</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">            echo &quot;false&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">            $pdo-&gt;rollBack();//数据处理失败，回滚事务           </span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        } else {</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">            echo &quot;true&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">            $pdo-&gt;commit();    //数据处理成功，提交事务</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        }               </span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    }catch(PDOException $e){</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        echo &quot;错误编号&quot;.$e-&gt;getCode().&quot;&lt;hr/&gt;&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        echo &quot;错误行&quot;.$e-&gt;getLine().&quot;&lt;hr/&gt;&quot;;</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">        echo &quot;错误信息&quot;.$e-&gt;getMessage();</span></span></div><div><span style="color: rgb(51, 51, 51);"><span style="font-size: 12px;">    }   </span></span></div></div><div><span style="font-size: 19px;"><b>六1、什么是异常</b></span></div><div style="margin-left:40px;">PHP 5 提供了一种新的面向对象的错误处理方法。</div><div style="margin-left:40px;">异常处理用于在指定的错误（异常）情况发生时改变脚本的正常流程。这种情况称为异常。</div><div style="margin-left:40px;"><b>2</b><b>、异常发生时的执行流程</b></div><div style="margin-left:40px;">①当前代码状态被保存</div><div style="margin-left:40px;">②代码执行被切换到预定义的异常处理器函数</div><div style="margin-left:40px;">③根据情况，处理器也许会从保存的代码状态重新开始执行代码，终止脚本执行，或从代码中另外的位置继续执行脚本。</div><div style="margin-left:40px;"><b>3</b><b>、</b><b>PDO</b><b>中的异常捕获</b></div><div style="box-sizing: border-box; padding: 8px; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);"><div style="margin-left:40px;">基本语法：</div><div style="margin-left:40px;">try {</div><div style="margin-left:40px;">    存在潜在错误的代码;</div><div style="margin-left:40px;">//设置PDO属性实现捕获逻辑异常,在执行SQL语句之前</div><div style="margin-left:40px;">    $pdo-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::EOOMODE_SILENT);<br/></div><div style="margin-left:40px;">    if(逻辑错误) {</div><div style="margin-left:40px;">       //手动抛出异常</div><div style="margin-left:40px;">       throw  new  PDOException(‘错误的文本信息’，’错误号’);</div><div style="margin-left:40px;">     }</div><div style="margin-left:40px;">} catch(PDOException $e) {</div><div style="margin-left:40px;">    echo ‘错误号：’.$e-&gt;getCode();</div><div style="margin-left:40px;">    echo ‘错误行号：’.$e-&gt;getLine();</div><div style="margin-left:40px;">    echo ‘错误的文本信息：’.$e-&gt;getMessage();</div><div style="margin-left:40px;">}</div></div><div style="margin-left:40px;">4、<font color="#010101" size="1"><span style="font-size:9pt">设置异常等级</span></font></div><div align="left" style="min-height: 10pt;margin-left:40px;"><div style="margin-left:40px;"><font color="#010101" size="1"><span style="font-size:9pt">通过PDO::setAttribute设置异常级别</span></font></div></div><div align="left" style="min-height: 10pt;margin-left:80px;"><div><font color="#010101" size="1"><span style="font-size:9pt">语法：bool PDO::setAttribute ( int $attribute , mixed $value )</span></font></div></div><div align="left" style="min-height: 10pt;margin-left:40px;"><div style="margin-left:40px;"><font color="#010101" size="1"><span style="font-size:9pt">参数：</span></font><font color="#010101" size="1"><span style="font-size:9pt">$attribute ：要设置的属性，</span></font><font color="#010101" size="1"><span style="font-size:9pt">$value ：要设置的属性值</span></font></div></div><div align="left" style="min-height: 10pt;margin-left:40px;"><div style="margin-left:40px;"><font color="#010101" size="1"><span style="font-size:9pt">PDO::ATTR_ERRMODE ：PDO异常级别</span></font></div></div><div align="left" style="min-height: 10pt;margin-left:80px;"><div><font color="#010101" size="1"><span style="font-size:9pt">① PDO::ERRMODE_SILENT ：常规错误，默认（致命错误等）</span></font></div></div><div align="left" style="min-height: 10pt;margin-left:80px;"><div><font color="#010101" size="1"><span style="font-size:9pt">② PDO::ERRMODE_WARNING ：警告错误</span></font></div></div><div align="left" style="min-height: 10pt;margin-left:80px;"><div><font color="#010101" size="1"><span style="font-size:9pt">③ PDO::ERRMODE_EXCEPTION ：异常错误</span></font></div></div><div align="left" style="min-height: 10pt;"><div style="margin-left:80px;"><font color="#010101" size="1"><span style="font-size:9pt">例如：$pdo-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::EOOMODE_SILENT);</span></font></div><div><b><span style="font-size: 19px;"><span style="color: rgb(1, 1, 1);">七、PDO常用属性</span></span></b></div><div align="left" style="min-height: 10pt;"><div style="margin-left:40px;"><font color="#010101">获取属性：$pdo-&gt;getAttribute()</font></div></div><div align="left" style="min-height: 10pt;"><div style="margin-left:40px;"><font color="#010101">设置属性：$pdo-&gt;setAttribute()</font></div><div align="justify" style="min-height: 14pt;margin-left:40px;"><div><font color="#010101">①</font><font color="#010101">PDO::ATTR_AUTOCOMMIT</font> <font color="#010101">：自动提交，常用于事务处理（语句事务）</font></div></div><div align="justify" style="min-height: 13pt;margin-left:40px;"><div><font color="#010101">参数值：</font><font color="#010101">   1</font> <font color="#010101">：自动提交，</font><font color="#010101">   0</font> <font color="#010101">：关闭自动提交</font></div></div><div align="justify" style="min-height: 14pt;margin-left:40px;"><div><font color="#010101">②</font><font color="#010101">PDO::ATTR_CASE</font><font color="#010101">：结果集大小写，</font><font color="#010101">参数值：</font></div></div><div align="justify" style="margin-right:0mm; text-indent:6mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 14pt;margin-left:40px;"><div><font color="#010101">PDO::CASE_LOWER</font><font color="#010101">（</font><font color="#010101">2</font><font color="#010101">）：把结果集（字段名称）全部转化为小写</font></div></div><div align="justify" style="margin-right:0mm; text-indent:6mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 14pt;margin-left:40px;"><div><font color="#010101">PDO::CASE_UPPER</font><font color="#010101">（</font><font color="#010101">1</font><font color="#010101">）：把结果集（字段名称）全部转化为大写</font></div></div><div align="justify" style="margin-right:0mm; text-indent:6mm; margin-top:0.00mm; margin-bottom:0.00mm;min-height: 14pt;margin-left:40px;"><div><font color="#010101">PDO::CASE_NATURAL</font><font color="#010101">（</font><font color="#010101">0</font><font color="#010101">）：正常返回</font></div></div><div align="justify" style="min-height: 14pt;margin-left:40px;"><div><font color="#010101">③</font><font color="#010101">PDO::ATTR_PERSISTENT</font><font color="#010101">：长连接</font></div></div><div align="left" style="min-height: 12pt;margin-left:40px;"><div><font color="#010101">默认为false，表示关闭长连接，设置为true，则开启长连接</font></div></div><div align="justify" style="min-height: 12pt;margin-left:40px;"><div><font color="#010101">注意：必须在pdo对象实例化之前设置</font><font color="#010101" size="1"><span style="font-size:9pt">$pdo-&gt;setAttribute(PDO::ATTR_PERSISTENT,true);</span></font></div></div><div align="justify" style="min-height: 14pt;margin-left:40px;"><div><font color="#010101">短连接：连接</font><font color="#010101">-》</font><font color="#010101">发送</font><font color="#010101">SQL</font><font color="#010101">语句</font><font color="#010101">-》</font> <font color="#010101">执行</font><font color="#010101">SQL</font><font color="#010101">语句</font><font color="#010101">-》</font> <font color="#010101">关闭</font></div></div><div align="justify" style="min-height: 14pt;"><div style="margin-left:40px;"><font color="#010101">长连接：连接</font><font color="#010101">-》</font> <font color="#010101">发送</font><font color="#010101">SQL</font><font color="#010101">语句</font><font color="#010101">-》</font> <font color="#010101">执行</font><font color="#010101">SQL</font><font color="#010101">语句</font><font color="#010101">-》</font> <font color="#010101">发送</font><font color="#010101">SQL</font><font color="#010101">语句</font><font color="#010101">-》</font> <font color="#010101">执行</font><font color="#010101">SQL</font><font color="#010101">语句</font><font color="#010101">…</font></div></div></div></div></span>
</div></body></html> 